name: Terraform Plan

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  TERRAGRUNT_VERSION: ${{ vars.TERRAGRUNT_VERSION }}
  TERRAFORM_VERSION: ${{ vars.TERRAFORM_VERSION }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.changes.outputs.components }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Downloads ENTIRE git history

      - name: Detect changed components
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- environments/)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- environments/)
          fi

          # Extract unique environment/component combinations
          COMPONENTS=$(echo "$CHANGED_FILES" | \
            grep -oP 'environments/\K[^/]+/[^/]+' | \
            sort -u | \
            jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')

          echo "components=$COMPONENTS" >> $GITHUB_OUTPUT
          echo "Changed components: $COMPONENTS"

  plan:
    needs: detect-changes
    if: needs.detect-changes.outputs.components != '[]'
    runs-on: ubuntu-latest
    # Run job per changed component in parallel
    strategy:
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.components) }}
      fail-fast: false

    permissions:
      contents: read
      pull-requests: write # comment on PR
      id-token: write  # request temporary AWS credentials via OIDC

    steps:
      - uses: actions/checkout@v4

      - name: Terragrunt Setup
        uses: ./.github/actions/terragrunt-setup
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}
          aws-region: ${{ env.AWS_REGION }}
          aws-role: ${{ env.AWS_ROLE_ARN }}

      - name: Terragrunt Plan
        uses: ./.github/actions/terragrunt-plan
        with:
          working-directory: environments/${{ matrix.component }}
